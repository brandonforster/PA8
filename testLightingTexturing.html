<!DOCTYPE html>
<html>
<head charset="UTF-8">
<title>Brandon Forster</title>
<style type="text/css">
textarea {
    border: thin solid black;
    position: relative;
    left: 5px;
	width: 75%;
    font: 10pt Consolas;
	overflow-x:auto;
	background-color: lightgray;
	color: brown;
}
p
{
text-align:justify;
text-indent:25px;
width: 90%;
}
li
{
text-align:justify;
width: 90%;
}
</style>
<script src="lib/webgl-utils.js"></script>
<script src="lib/webgl-debug.js"></script>
<script src="lib/cuon-utils.js"></script>
<script src="lib/cuon-matrix.js"></script>
<script src="shaderLightingTexturing.js"></script>
<script src="jsonRenderable.js"></script>
<script src="camera.js"></script>
<script src="quad.js"></script>
<script type="text/javascript">
"use strict";
//This function gets called when reading a JSON file. It stores the current xml information.

var newModelFlag = true;
var dollyRequired=0;
var rotateFlag =true;
var angle=0;
function toggleRotateFlag(){rotateFlag = !rotateFlag;}

function main(){
	// ... global variables ...
	var gl,model,camera,program;
	var quadProgram, quad;
	var canvas = null;
	var messageField = null;
	
	canvas = document.getElementById("myCanvas1");
	addMessage(((canvas)?"Canvas acquired":"Error: Can not acquire canvas"));
	var gl = canvas.getContext("experimental-webgl", {stencil:true});
		
	program=createShaderProgram(gl);
	
	quadProgram= createQuadProgram(gl);
	quad= new Quad(gl, quadProgram);
	
	gl.clearColor(0,0,0,1);
	gl.enable(gl.DEPTH_TEST);
	gl.enable(gl.STENCIL_TEST); 
	draw();
	return 1;
	function draw(){
		gl.clear( gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT | gl.STENCIL_BUFFER_BIT ); 
		gl.useProgram(program);
	
		if (newModelFlag)newModel();
		if (dollyRequired){camera.dolly(0.05*dollyRequired);dollyRequired=0;}
		
		var projMatrix = camera.getProjMatrix();
		gl.uniformMatrix4fv(program.uniformLocations["projT"], false, projMatrix.elements);
		var viewMatrix = camera.getRotatedViewMatrix(angle);
		gl.uniformMatrix4fv(program.uniformLocations["viewT"], false, viewMatrix.elements);

		gl.stencilFunc(gl.EQUAL,0,0xFF);
		gl.stencilOp( (0 & 0xFF), gl.INVERT, (model.draw() & (0xFF))  );
		if (rotateFlag){angle++; if (angle > 360) angle -= 360;}

		gl.useProgram(quadProgram);
		quad.draw();
		
		gl.useProgram(null);

		window.requestAnimationFrame(draw);
	}
	function newModel(path)
	{
		function getCurrentModelPath(){
			return document.getElementById("modelList").value;
			//return pathname;
		}
		if (model) model.delete();
		if (!path) path = getCurrentModelPath();
		console.log(path);
		model=new JsonRenderable(gl,program,"./lib/model/"+path+"/models/","model.json");
		if (!model)alert("No model could be read");
		else newModelFlag = false;
		var bounds = model.getBounds();
		camera = new Camera(gl,program,bounds,[0,1,0]);
		var newEye=camera.getRotatedCameraPosition(angle);
		gl.uniform3f(program.uniformLocations["eyePosition"],newEye[0],newEye[1],newEye[2]);
	}
}
</script>
</head>
<body onload="main();">
<h2>Brandon Forster PA8</h2>
<br><canvas id="myCanvas1" width="600px" height="600px" style="border:1px solid #FF0000; background: pink"></canvas>
<br>ModelList:<select id="modelList" onchange="newModelFlag=true;">
  <option value="teapot">teapot</option>
  <option value="skull">skull</option>
  <option value="House">House</option>
</select>
Dolly:<input type='button' value='+' onclick="dollyRequired=1;"/>
	<input type='button' value='-' onclick="dollyRequired=-1;"/>	
	<br>
	Toggle Rotate: <input type='button' value='Toggle' onclick="toggleRotateFlag();"/>	
</body>
</html>